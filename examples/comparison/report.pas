Unit Report;

{$mode ObjFPC}{$H+}

Interface

Uses
  Classes, SysUtils,
  Instrument, RemoteInstrument,
  Comparison, Diagrams;

Type

  { TComparisonReport }

  TComparisonReport = class
    FComparison        : TComparisonBase;
//    FCoord             : TBipolarSemiLogXBase;
//    FDiagram           : TVectorialDiagram;
    Constructor Create(AComparison:TComparisonBase);
    Destructor  Destroy; override;
    Procedure WriteReport(AFilename : String);
  End;

Implementation

{ TComparisonReport }

Constructor TComparisonReport.Create(AComparison : TComparisonBase);
Begin
  inherited Create;
  FComparison := AComparison;
End;

Destructor TComparisonReport.Destroy;
Begin
  inherited Destroy;
End;

Procedure TComparisonReport.WriteReport(AFilename : String);

  Function ExcapeLaTeX(St:String):String;
  Begin
    Result := St;
    Result := StringReplace(Result, '\', '\\', [rfReplaceAll]);
    Result := StringReplace(Result, '_', '\_', [rfReplaceAll]);
    Result := StringReplace(Result, '%', '\%', [rfReplaceAll]);
    Result := StringReplace(Result, '#', '\#', [rfReplaceAll]);
    Result := StringReplace(Result, '{', '\}', [rfReplaceAll]);
    Result := StringReplace(Result, '}', '\}', [rfReplaceAll]);
  End;

Var S           : TStringList;
    NI,NR,NS,NP : Integer;
    AllRanges   : TInstrumentRanges;
    Prev        : TComparisonSet;
    Instrument  : TInstrumentWrapperBase;
    Range       : TMeasureRangeBase;
    Diag        : TComparisonDiagrams;
Begin
  S := TStringList.Create;
  S.Add('% Autogenerated comparison report on '+FormatDateTime('yyyy-mm-dd hh:mm:ss', Now));
  S.Add('\documentclass[11pt, a4paper, twoside, titlepage]{article}');
  S.Add('\usepackage[latin1]{inputenc}');
  S.Add('\usepackage[T1]{fontenc}');
  S.Add('\usepackage[inkscapelatex=false]{svg}');
  S.Add('');
  S.Add('\setlength{\parindent}{0mm}');
  S.Add('\setlength{\parskip}{2ex}');
  S.Add('');
  S.Add('\title{'+'Test Report'+'}');
  S.Add('');
  S.Add('\begin{document}');
  S.Add('');
  S.Add('\maketitle');
  S.Add('');

  S.Add('%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%');
  S.Add('\section{Summary}');
  S.Add('Filename: \textbf{'+'TODO'+'}');
  S.Add('');
  S.Add('Quantity: \textbf{'+CQuantityStr[FComparison.FQuantity]+'}');
  S.Add('');
  S.Add('Instruments:');
  S.Add('\begin{description}');
  For NI := 0 to Length(FComparison.FInstruments)-1 do
    Begin
      S.Add('  \item['+ExcapeLaTeX(FComparison.FInstruments[NI].FName)+':] '+FComparison.FInstruments[NI].FWrapperName +', \texttt{'+ExcapeLaTeX(StringReplace(FComparison.FInstruments[NI].GetParams.ToSyntax, ',', ', ', [rfReplaceAll]))+'}');
    End;
  S.Add('\end{description}');
  S.Add('\textbf{TODO:} serial numbers');
  S.Add('');
  S.Add('Result: \textbf{'+'TODO'+'}');
  S.Add('');
  S.Add('');
  S.Add('');
  S.Add('');

  Diag := TComparisonDiagrams.Create(FComparison);
  Diag.FLabel1Indent  :=  3.0;
  Diag.FLabel2Indent  :=  7.0;
  Diag.FLabelFontSize           := 10.0/72.0*25.4;
  Diag.FDiagram.FXTickFontSize  := 10.0/72.0*25.4;
  Diag.FDiagram.FTickLenDrw     := 1.2;
  Diag.FDiagram.FXBreakExtDrw   := 1.7;
  Diag.FDiagram.FXBreakSlantDrw := 0.5;
  Diag.FDiagram.FXBreakSpaceDrw := 0.5;
  Diag.FTestPointLenDrw         := 1.2;
  Diag.FResultLenDrw            := 1.2;

  // TODO: size of diagram should depend on number of rows
  Diag.DrawRanges(140, 120, Nil);
  Diag.FDiagram.WriteSVG('test-ranges-gen.svg');
  Diag.DrawProcedure(140, 120, Nil);
  Diag.FDiagram.WriteSVG('test-procedure-gen.svg');
  Diag.DrawResults(140, 120, Nil);
  Diag.FDiagram.WriteSVG('test-results-gen.svg');

  S.Add('\begin{figure}[htb]');
  S.Add('  \centering');
  S.Add('  \includesvg{test-ranges-gen.svg}');
  S.Add('  \caption{My figure}');
  S.Add('\end{figure}');
  S.Add('');
  S.Add('\begin{figure}[htb]');
  S.Add('  \centering');
  S.Add('  \includesvg{test-procedure-gen.svg}');
  S.Add('  \caption{My figure}');
  S.Add('\end{figure}');
  S.Add('');
  S.Add('\begin{figure}[htb]');
  S.Add('  \centering');
  S.Add('  \includesvg{test-results-gen.svg}');
  S.Add('  \caption{My figure}');
  S.Add('\end{figure}');
  S.Add('');

  S.Add('\end{document}');

  // save
  S.SaveToFile(AFilename);
  S.Free;
End;

End.

